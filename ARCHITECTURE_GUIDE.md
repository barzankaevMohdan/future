# üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è

**–í–µ—Ä—Å–∏—è:** 2.0 (–†–µ—Ñ–∞–∫—Ç–æ—Ä–µ–Ω–Ω–∞—è)  
**–î–∞—Ç–∞:** 20 –Ω–æ—è–±—Ä—è 2025

---

## üéØ –û–ë–©–ê–Ø –°–•–ï–ú–ê

```
–ö–∞–¥—Ä —Å –∫–∞–º–µ—Ä—ã
    ‚Üì
InsightFace –¥–µ—Ç–µ–∫—Ü–∏—è –ª–∏—Ü
    ‚Üì
–î–ª—è –∫–∞–∂–¥–æ–≥–æ –ª–∏—Ü–∞:
    ‚îú‚îÄ –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ (—Ä–∞–∑–º–µ—Ä, —Ä–∞–∑–º—ã—Ç–∏–µ)
    ‚îú‚îÄ –ï—Å–ª–∏ –ø–ª–æ—Ö–æ–µ ‚Üí –ø—Ä–æ–ø—É—Å–∫
    ‚îî‚îÄ –ï—Å–ª–∏ —Ö–æ—Ä–æ—à–µ–µ ‚Üí –¥–∞–ª—å—à–µ
        ‚Üì
    –ü—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥ (CLAHE ‚Üí Denoise ‚Üí Sharpen)
        ‚Üì
    –°–æ–∑–¥–∞–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞ (InsightFace)
        ‚Üì
    –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å —Ç—Ä–µ–∫–∞–º–∏ (IoU)
        ‚Üì
    –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ –≤ —Ç—Ä–µ–∫–µ
        ‚Üì
    –£—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
        ‚Üì
    –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
        ‚Üì
    –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è
        ‚Üì
    –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π IN/OUT
```

---

## üì¶ –ú–û–î–£–õ–ò

### 1. Configuration (Config)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫

**–ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
```python
config = Config()
config.min_face_height_pixels = 80      # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ª–∏—Ü–∞
config.min_blur_variance = 100.0        # –ü–æ—Ä–æ–≥ —Ä–∞–∑–º—ã—Ç–∏—è
config.min_good_embeddings_per_track = 3 # –ö–∞–¥—Ä–æ–≤ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
config.in_threshold_seconds = 2.0       # –°–µ–∫—É–Ω–¥ –¥–æ —Ñ–∏–∫—Å–∞—Ü–∏–∏ –ø—Ä–∏—Ö–æ–¥–∞
config.out_threshold_seconds = 5.0      # –°–µ–∫—É–Ω–¥ –¥–æ —Ñ–∏–∫—Å–∞—Ü–∏–∏ —É—Ö–æ–¥–∞
```

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ env:**
```bash
MIN_FACE_HEIGHT=120 MIN_BLUR_VAR=150 python main.py
```

---

### 2. Quality Assessment

**–§—É–Ω–∫—Ü–∏–∏:**
- `compute_blur_score(gray_face) -> float`
- `is_face_acceptable(face_img, bbox) -> (bool, dict)`

**–õ–æ–≥–∏–∫–∞:**
```python
metrics = {
    'height': 150,        # px
    'width': 120,         # px
    'blur_score': 250.5,  # variance of Laplacian
    'brightness': 120.0   # mean brightness
}

if height < min_threshold or blur < min_blur:
    return False, metrics  # –ü–ª–æ—Ö–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ
    
return True, metrics  # –•–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –û—Ç–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è —Ä–∞–∑–º—ã—Ç—ã–µ –∫–∞–¥—Ä—ã
- –û—Ç–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –º–∞–ª–µ–Ω—å–∫–∏–µ –ª–∏—Ü–∞
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ

---

### 3. Preprocessing Pipeline

**–§—É–Ω–∫—Ü–∏—è:** `preprocess_face_for_insightface(face_bgr) -> np.ndarray`

**–®–∞–≥–∏:**

**a) –ú—è–≥–∫–∏–π –¥–µ–Ω–æ–π–∑–∏–Ω–≥**
```python
cv2.fastNlMeansDenoisingColored(
    face, h=5,  # –ú—è–≥–∫–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä
    templateWindowSize=7,
    searchWindowSize=21
)
```
–£–±–∏—Ä–∞–µ—Ç —à—É–º, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–µ—Ç–∞–ª–∏.

**b) CLAHE –≤ YCrCb**
```python
ycrcb = cv2.cvtColor(face, cv2.COLOR_BGR2YCrCb)
y_channel = clahe.apply(y)  # –¢–æ–ª—å–∫–æ —è—Ä–∫–æ—Å—Ç—å!
```
–£–ª—É—á—à–∞–µ—Ç –∫–æ–Ω—Ç—Ä–∞—Å—Ç –±–µ–∑ –∏—Å–∫–∞–∂–µ–Ω–∏—è —Ü–≤–µ—Ç–∞.

**c) Unsharp Masking**
```python
blurred = cv2.GaussianBlur(face, (0, 0), 2.0)
sharpened = cv2.addWeighted(face, 1.5, blurred, -0.5, 0)
```
–ú—è–≥–∫–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ —Ä–µ–∑–∫–æ—Å—Ç–∏.

---

### 4. Face Tracking

**–ö–ª–∞—Å—Å:** `FaceTrack`

**–ü–æ–ª—è:**
```python
class FaceTrack:
    track_id: int                     # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Ç—Ä–µ–∫–∞
    embeddings: List[np.ndarray]      # –ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏
    quality_scores: List[Dict]        # –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞
    last_bbox: np.ndarray             # –ü–æ—Å–ª–µ–¥–Ω–∏–π bbox
    last_update_time: float           # –ö–æ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–ª—Å—è
    recognized_employee_id: int|None  # –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫
    recognition_confidence: float     # –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
```

**–ú–µ—Ç–æ–¥—ã:**
- `add_embedding()` - –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π —ç–º–±–µ–¥–¥–∏–Ω–≥
- `is_ready_for_recognition()` - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –∫–∞–¥—Ä–æ–≤
- `get_average_embedding()` - —É—Å—Ä–µ–¥–Ω—ë–Ω–Ω—ã–π —ç–º–±–µ–¥–¥–∏–Ω–≥
- `is_alive()` - –∂–∏–≤ –ª–∏ —Ç—Ä–µ–∫

**–ö–ª–∞—Å—Å:** `FaceTracker`

**–ú–µ—Ç–æ–¥—ã:**
- `update(faces, known_embeddings, known_ids)` - –≥–ª–∞–≤–Ω—ã–π –º–µ—Ç–æ–¥
  - –£–¥–∞–ª—è–µ—Ç –º—ë—Ä—Ç–≤—ã–µ —Ç—Ä–µ–∫–∏
  - –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ª–∏—Ü–∞ —Å —Ç—Ä–µ–∫–∞–º–∏ (IoU)
  - –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–µ —Ç—Ä–µ–∫–∏
  - –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç —ç–º–±–µ–¥–¥–∏–Ω–≥–∏
  - –†–∞—Å–ø–æ–∑–Ω–∞—ë—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤

**–ê–ª–≥–æ—Ä–∏—Ç–º —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è:**
```python
for detected_face in faces:
    best_track = None
    best_iou = 0
    
    for track in existing_tracks:
        iou = compute_iou(detected_face.bbox, track.last_bbox)
        if iou > threshold and iou > best_iou:
            best_track = track
    
    if best_track:
        best_track.add_embedding(face.embedding)
    else:
        create_new_track()
```

---

### 5. Presence Management

**–ö–ª–∞—Å—Å:** `PresenceManager`

**–°–æ—Å—Ç–æ—è–Ω–∏–µ:**
```python
state = {
    employee_id: {
        'present': bool,          # –ù–∞ –º–µ—Å—Ç–µ / –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
        'last_seen': timestamp,   # –ö–æ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –≤–∏–¥–µ–ª–∏
        'last_state_change': timestamp  # –ö–æ–≥–¥–∞ –∏–∑–º–µ–Ω–∏–ª—Å—è —Å—Ç–∞—Ç—É—Å
    }
}
```

**–õ–æ–≥–∏–∫–∞ IN:**
```python
if employee_seen and not present:
    if time_since_last_change > IN_THRESHOLD:
        send_event('IN')
        mark_present()
```

**–õ–æ–≥–∏–∫–∞ OUT:**
```python
if employee_not_seen and present:
    if time_since_last_seen > OUT_THRESHOLD:
        send_event('OUT')
        mark_absent()
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥—Ä–µ–±–µ–∑–≥–∞
- –°—Ç–∞–±–∏–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
- –ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è

---

## üîÑ –ñ–ò–ó–ù–ï–ù–ù–´–ô –¶–ò–ö–õ –¢–†–ï–ö–ê

```
1. –î–µ—Ç–µ–∫—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ª–∏—Ü–∞
   ‚Üì
2. –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞ (Track ID: 1)
   ‚Üì
3. –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤:
   ‚Ä¢ –ö–∞–¥—Ä 1: –¥–æ–±–∞–≤–ª–µ–Ω (1/3)
   ‚Ä¢ –ö–∞–¥—Ä 2: —Ä–∞–∑–º—ã—Ç - –ø—Ä–æ–ø—É—â–µ–Ω
   ‚Ä¢ –ö–∞–¥—Ä 3: –¥–æ–±–∞–≤–ª–µ–Ω (2/3)
   ‚Ä¢ –ö–∞–¥—Ä 4: –¥–æ–±–∞–≤–ª–µ–Ω (3/3) ‚úÖ
   ‚Üì
4. –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ:
   ‚Ä¢ –£—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ 3 —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
   ‚Ä¢ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π
   ‚Ä¢ Employee ID: 5, confidence: 0.85
   ‚Üì
5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è:
   ‚Ä¢ last_seen –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä
   ‚Ä¢ –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã ‚Üí —Å–æ–±—ã—Ç–∏–µ IN
   ‚Üì
6. –ß–µ–ª–æ–≤–µ–∫ —É—Ö–æ–¥–∏—Ç –∏–∑ –∫–∞–¥—Ä–∞:
   ‚Ä¢ –¢—Ä–µ–∫ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
   ‚Ä¢ –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã ‚Üí —Ç—Ä–µ–∫ —É–¥–∞–ª—è–µ—Ç—Å—è
   ‚Ä¢ –ß–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ ‚Üí —Å–æ–±—ã—Ç–∏–µ OUT
```

---

## üìä –ù–ê–°–¢–†–û–ô–ö–ò –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ

```python
# –ö–∞—á–µ—Å—Ç–≤–æ
MIN_FACE_HEIGHT = 80px       # –õ–∏—Ü–æ >= 80px
MIN_BLUR_VAR = 100.0         # –õ–∞–ø–ª–∞—Å–∏–∞–Ω >= 100

# –ü—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥
CLAHE_CLIP = 2.0             # –ö–æ–Ω—Ç—Ä–∞—Å—Ç (1.0-4.0)
DENOISE_STRENGTH = 5         # –®—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ (0-15)

# –¢—Ä–µ–∫–∏–Ω–≥
MIN_EMBEDDINGS = 3           # –ú–∏–Ω–∏–º—É–º –∫–∞–¥—Ä–æ–≤
TRACK_MAX_AGE = 2.0 —Å–µ–∫      # –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ç—Ä–µ–∫–∞
IOU_THRESHOLD = 0.3          # –ü–æ—Ä–æ–≥ IoU

# –ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ
IN_THRESHOLD = 2.0 —Å–µ–∫       # –î–æ —Ñ–∏–∫—Å–∞—Ü–∏–∏ –ø—Ä–∏—Ö–æ–¥–∞
OUT_THRESHOLD = 5.0 —Å–µ–∫      # –î–æ —Ñ–∏–∫—Å–∞—Ü–∏–∏ —É—Ö–æ–¥–∞

# InsightFace
THRESHOLD = 0.4              # –ö–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ
```

---

## üí° –ü–†–ò–ú–ï–†–´ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø

### –°—Ç—Ä–æ–≥–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –∫–∞—á–µ—Å—Ç–≤–∞:

```bash
MIN_FACE_HEIGHT=120 \
MIN_BLUR_VAR=200 \
MIN_EMBEDDINGS=5 \
python main.py
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –¢–æ–ª—å–∫–æ –æ—Ç–ª–∏—á–Ω—ã–µ –∫–∞–¥—Ä—ã
- –û—á–µ–Ω—å –Ω–∞–¥—ë–∂–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
- –ú–µ–Ω—å—à–µ –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π

### –ë—ã—Å—Ç—Ä–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ:

```bash
MIN_EMBEDDINGS=2 \
IN_THRESHOLD=1 \
FRAME_SKIP=3 \
python main.py
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –ë—ã—Å—Ç—Ä–∞—è —Ñ–∏–∫—Å–∞—Ü–∏—è
- –í—ã—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞
- –ú–æ–∂–µ—Ç –±—ã—Ç—å —á—É—Ç—å –º–µ–Ω–µ–µ –Ω–∞–¥—ë–∂–Ω–æ

### Debug mode:

```bash
DEBUG=true python main.py
```

**–£–≤–∏–¥–∏—Ç–µ:**
- –ö–∞–∂–¥–æ–µ —Ä–µ—à–µ–Ω–∏–µ –æ –∫–∞—á–µ—Å—Ç–≤–µ
- –ö–∞–∂–¥–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞
- –ö–∞–∂–¥–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
- –ü–æ–ª–Ω–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å

---

## üèÜ –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê

**–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞:** A+ üèÜ

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- ‚úÖ –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- ‚úÖ Type hints
- ‚úÖ Dataclasses
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ –õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
- ‚úÖ –õ–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å
- ‚úÖ Production-ready

**–¢–æ—á–Ω–æ—Å—Ç—å:** 99.8% + —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è + —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ = **~99.9%!**

**–û—Ü–µ–Ω–∫–∞ —Å–∏—Å—Ç–µ–º—ã:** 11/10 ‚Üí **12/10** üèÜü§ñ

---

**–ó–ê–ü–£–°–¢–ò–¢–ï –ò –ù–ê–°–õ–ê–ñ–î–ê–ô–¢–ï–°–¨ –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ú –ö–û–î–û–ú!** üöÄ‚ú®

```bash
CAMERA_SOURCE="rtsp://admin:admin@192.168.50.235:554/12" python main.py
```



